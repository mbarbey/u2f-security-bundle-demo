{% extends 'base.html.twig' %}

{% block body %}
    <h1>U2F registration</h1>
    {{ form_start(form) }}
    {{ form_rest(form) }}
    {{ form_end(form) }}
    
    {{ dump(authenticationRequest) }}
    
    {% if error %}
        {{ dump(error) }}
    {% endif %}
    
{% endblock %}


{% block javascripts %}
    <script src="{{ asset('bundles/mbarbeyu2fsecurity/u2f.js') }}"></script>
    <script type="text/javascript">
        setTimeout(function() {
            // Magic JavaScript talking to your HID
            u2f.sign("{{ authenticationRequest.appId }}", "{{ authenticationRequest.challenge }}", {{ authenticationRequest.registeredKeys|raw }}, function(data) {
                
                // Handle returning error data
                if(data.errorCode && data.errorCode != 0) {
                    alert("Authentication failed with error: " + data.errorCode);
                    // Or handle the error however you'd like. 
                    
                    return;
                }
        
                // On success process the data from USB device to send to the server
                var authentication_response = data;
                
                // Get the form items so we can send data back to the server
                var form = document.getElementsByTagName('form')[0];
                var response = document.getElementById('{{ form.response.vars.id }}');
                
                // Fill and submit form.
                response.value = JSON.stringify(authentication_response);
                form.submit();
            });
        }, 1000);
    </script>
{% endblock %}